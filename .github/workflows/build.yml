name: Build PHP for Windows

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬ç±»åž‹ (Version Type)'
        required: true
        type: choice
        options:
          - stable
          - testing
          - development
        default: 'stable'

      # ç¨³å®šç‰ˆè¾“å…¥
      stable_version:
        description: 'ç¨³å®šç‰ˆç‰ˆæœ¬å· (å¦‚: 8.4.14, 8.3.15) - ä»…å½“é€‰æ‹© stable æ—¶æœ‰æ•ˆ'
        required: false
        default: '8.4.14'

      # æµ‹è¯•ç‰ˆè¾“å…¥
      testing_tag:
        description: 'æµ‹è¯•ç‰ˆæ ‡ç­¾ (å¦‚: php-8.5.0beta2, php-8.5.0RC4) - ä»…å½“é€‰æ‹© testing æ—¶æœ‰æ•ˆ'
        required: false
        default: 'php-8.5.0beta2'

      # å¼€å‘ç‰ˆè¾“å…¥
      dev_commit:
        description: 'å¼€å‘ç‰ˆ commit hash (å¯é€‰ï¼Œç•™ç©ºä½¿ç”¨ master åˆ†æ”¯) - ä»…å½“é€‰æ‹© development æ—¶æœ‰æ•ˆ'
        required: false
        default: ''

      dev_version:
        description: 'å¼€å‘ç‰ˆç‰ˆæœ¬å· (å¦‚: 8.6.0-dev-20251105) - ä»…å½“é€‰æ‹© development æ—¶æœ‰æ•ˆ'
        required: false
        default: '8.6.0-dev-latest'

      # æž„å»ºé…ç½®
      arch:
        description: 'æž¶æž„ (Architecture)'
        required: true
        type: choice
        options:
          - x64
          - x86
        default: 'x64'

      thread_safe:
        description: 'çº¿ç¨‹å®‰å…¨ (Thread Safe)'
        required: true
        type: choice
        options:
          - nts
          - ts
        default: 'nts'

      # æ‰©å±•é…ç½®
      build_extensions:
        description: 'æž„å»ºæ‰©å±• (Build Extensions)'
        type: boolean
        default: true

      extensions_json:
        description: 'æ‰©å±•é…ç½® JSON (å¦‚: [{"name":"xdebug","url":"https://github.com/xdebug/xdebug","ref":"3.4.0","args":"--enable-xdebug"}])'
        required: false
        default: ''

      # å‘å¸ƒé€‰é¡¹
      create_release:
        description: 'åˆ›å»º GitHub Release'
        type: boolean
        default: true

jobs:
  # å‡†å¤‡æž„å»ºä¿¡æ¯
  prepare:
    runs-on: ubuntu-latest
    outputs:
      php-version: ${{ steps.version.outputs.php-version }}
      php-source: ${{ steps.version.outputs.php-source }}
      php-build-version: ${{ steps.version.outputs.php-build-version }}
      extension-php-version: ${{ steps.version.outputs.extension-php-version }}
      version-type: ${{ steps.version.outputs.version-type }}
      package-name: ${{ steps.version.outputs.package-name }}
      extensions-json: ${{ steps.extensions.outputs.extensions-json }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Determine PHP Version and Source
        id: version
        run: |
          VERSION_TYPE="${{ github.event.inputs.version_type }}"

          case "$VERSION_TYPE" in
            stable)
              PHP_VERSION="${{ github.event.inputs.stable_version }}"
              # ç¨³å®šç‰ˆ tag æ ¼å¼ä¸º php-x.y.z
              PHP_SOURCE="php-$PHP_VERSION"
              # æž„å»ºç‰ˆæœ¬å·å°±æ˜¯è¾“å…¥çš„ç‰ˆæœ¬å·
              PHP_BUILD_VERSION="$PHP_VERSION"
              # æ‰©å±•æž„å»ºä¹Ÿä½¿ç”¨ç›¸åŒç‰ˆæœ¬
              EXTENSION_PHP_VERSION="$PHP_VERSION"
              ;;
            testing)
              TAG="${{ github.event.inputs.testing_tag }}"
              # æµ‹è¯•ç‰ˆ tag å·²åŒ…å« php- å‰ç¼€ï¼ŒåŽ»é™¤å‰ç¼€å¾—åˆ°ç‰ˆæœ¬å·
              PHP_VERSION="${TAG#php-}"
              PHP_SOURCE="$TAG"
              # æž„å»ºç‰ˆæœ¬å·ä½¿ç”¨å®Œæ•´ç‰ˆæœ¬å·ï¼ˆä¸å« php- å‰ç¼€ï¼Œæž„å»ºå™¨ä¼šè‡ªåŠ¨æ·»åŠ ï¼‰
              PHP_BUILD_VERSION="$PHP_VERSION"
              # æ‰©å±•æž„å»ºä¹Ÿä½¿ç”¨å®Œæ•´ç‰ˆæœ¬å·ï¼Œé…åˆä¸‹è½½çš„ artifacts ä½¿ç”¨
              EXTENSION_PHP_VERSION="$PHP_VERSION"
              ;;
            development)
              COMMIT="${{ github.event.inputs.dev_commit }}"
              PHP_VERSION="${{ github.event.inputs.dev_version }}"
              if [ -n "$COMMIT" ]; then
                # ä½¿ç”¨æŒ‡å®šçš„ commit hash
                PHP_SOURCE="$COMMIT"
              else
                # ä½¿ç”¨ master åˆ†æ”¯æœ€æ–°ä»£ç 
                PHP_SOURCE="master"
              fi
              # å¼€å‘ç‰ˆç»Ÿä¸€ä½¿ç”¨ master ä½œä¸ºæž„å»ºç‰ˆæœ¬
              PHP_BUILD_VERSION="master"
              # æ‰©å±•æž„å»ºä¹Ÿä½¿ç”¨ master
              EXTENSION_PHP_VERSION="master"
              ;;
          esac

          # ç”ŸæˆåŒ…åï¼ˆä¸Ž build-php job ä¸­çš„æ ¼å¼ä¸€è‡´ï¼‰
          PACKAGE_NAME="php-$PHP_VERSION-${{ github.event.inputs.thread_safe }}-Win-${{ github.event.inputs.arch }}"

          echo "php-version=$PHP_VERSION" >> $GITHUB_OUTPUT
          echo "php-source=$PHP_SOURCE" >> $GITHUB_OUTPUT
          echo "php-build-version=$PHP_BUILD_VERSION" >> $GITHUB_OUTPUT
          echo "extension-php-version=$EXTENSION_PHP_VERSION" >> $GITHUB_OUTPUT
          echo "version-type=$VERSION_TYPE" >> $GITHUB_OUTPUT
          echo "package-name=$PACKAGE_NAME" >> $GITHUB_OUTPUT

          echo "PHP Version: $PHP_VERSION"
          echo "PHP Source: $PHP_SOURCE"
          echo "PHP Build Version: $PHP_BUILD_VERSION"
          echo "Extension PHP Version: $EXTENSION_PHP_VERSION"
          echo "Version Type: $VERSION_TYPE"
          echo "Package Name: $PACKAGE_NAME"

      - name: Prepare Extensions Configuration
        id: extensions
        run: |
          CUSTOM_JSON='${{ github.event.inputs.extensions_json }}'
          VERSION_TYPE='${{ steps.version.outputs.version-type }}'
          PHP_VERSION='${{ steps.version.outputs.php-version }}'

          if [ -n "$CUSTOM_JSON" ]; then
            # ä½¿ç”¨è‡ªå®šä¹‰æ‰©å±•é…ç½®
            echo "Using custom extensions configuration"
            EXTENSIONS_JSON="$CUSTOM_JSON"
          else
            # æ ¹æ® PHP ç‰ˆæœ¬é€‰æ‹©æ‰©å±•é…ç½®
            if [[ "$VERSION_TYPE" == "development" ]] || [[ "$PHP_VERSION" =~ ^8\.6 ]]; then
              # PHP 8.6 (master/dev) - åªæ”¯æŒéƒ¨åˆ†æ‰©å±•
              echo "Using PHP 8.6 extensions configuration (limited support)"
              EXTENSIONS_JSON=$(cat extensions.php8.6.json)
              echo "Note: PHP 8.6 supports: redis, imagick, memcache, memcached, imap"
              echo "Unsupported (missing patches): xdebug"
            else
              # å…¶ä»–ç‰ˆæœ¬ - ä½¿ç”¨å®Œæ•´æ‰©å±•é…ç½®
              echo "Using default extensions configuration"
              EXTENSIONS_JSON=$(cat extensions.default.json)
            fi
          fi

          # è¾“å‡ºä¸ºå•è¡Œ JSON
          EXTENSIONS_JSON_SINGLE=$(echo "$EXTENSIONS_JSON" | jq -c .)
          echo "extensions-json=$EXTENSIONS_JSON_SINGLE" >> $GITHUB_OUTPUT

          echo "Extensions to build:"
          echo "$EXTENSIONS_JSON" | jq -r '.[].name'

  # æž„å»º PHP
  build-php:
    needs: prepare
    runs-on: windows-2022
    steps:
      - name: Build PHP
        uses: ServBay/php-windows-builder/php@master
        with:
          php-version: ${{ needs.prepare.outputs.php-build-version }}
          arch: ${{ github.event.inputs.arch }}
          ts: ${{ github.event.inputs.thread_safe }}

      - name: Package PHP Build
        shell: powershell
        run: |
          $PHP_VERSION = "${{ needs.prepare.outputs.php-version }}"
          $ARCH = "${{ github.event.inputs.arch }}"
          $TS = "${{ github.event.inputs.thread_safe }}"

          # ç”ŸæˆåŒ…åï¼ˆåŸºç¡€åŒ…ï¼šphp-{version}-windows-{arch}-no-extensionsï¼‰
          $PACKAGE_NAME = "php-$PHP_VERSION-windows-$ARCH-no-extensions"

          Write-Host "Creating packages: $PACKAGE_NAME (no extensions)"
          Write-Host "Thread Safety: $TS"

          # artifacts ç›®å½•å·²ç»ç”±å®˜æ–¹ action åˆ›å»º
          if (Test-Path "artifacts") {
            # ä½¿ç”¨ 7-Zip ç”Ÿæˆ ZIP æ ¼å¼ï¼ˆç¡®ä¿è·¯å¾„ä½¿ç”¨æ­£æ–œæ ï¼‰
            Write-Host "Creating ZIP package..."
            & "C:\Program Files\7-Zip\7z.exe" a -tzip "$PACKAGE_NAME.zip" ".\artifacts\*"
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Error: Failed to create ZIP package"
              exit 1
            }

            # ç”Ÿæˆ ZIP çš„ SHA256
            $zipHash = (Get-FileHash -Path "$PACKAGE_NAME.zip" -Algorithm SHA256).Hash
            "$zipHash  $PACKAGE_NAME.zip" | Out-File -FilePath "$PACKAGE_NAME.zip.sha256" -Encoding ASCII
            Write-Host "ZIP package created: $PACKAGE_NAME.zip"
            Write-Host "  Size: $([math]::Round((Get-Item $PACKAGE_NAME.zip).Length / 1MB, 2)) MB"
            Write-Host "  SHA256: $zipHash"

            # ä½¿ç”¨ 7-Zip ç”Ÿæˆ 7Z æ ¼å¼ï¼ˆæ›´é«˜åŽ‹ç¼©çŽ‡ï¼‰
            Write-Host "`nCreating 7Z package..."
            & "C:\Program Files\7-Zip\7z.exe" a -t7z -m0=lzma2 -mx=9 -mmt=on "$PACKAGE_NAME.7z" ".\artifacts\*"
            if ($LASTEXITCODE -ne 0) {
              Write-Host "Error: Failed to create 7Z package"
              exit 1
            }

            # ç”Ÿæˆ 7Z çš„ SHA256
            $7zHash = (Get-FileHash -Path "$PACKAGE_NAME.7z" -Algorithm SHA256).Hash
            "$7zHash  $PACKAGE_NAME.7z" | Out-File -FilePath "$PACKAGE_NAME.7z.sha256" -Encoding ASCII
            Write-Host "7Z package created: $PACKAGE_NAME.7z"
            Write-Host "  Size: $([math]::Round((Get-Item "$PACKAGE_NAME.7z").Length / 1MB, 2)) MB"
            Write-Host "  SHA256: $7zHash"

            # ä¿å­˜åŒ…åä¾›åŽç»­ä½¿ç”¨
            echo "PACKAGE_NAME=$PACKAGE_NAME" >> $env:GITHUB_ENV
          } else {
            Write-Host "Error: artifacts directory not found"
            exit 1
          }

      - name: Upload Release Package
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.PACKAGE_NAME }}
          path: |
            ${{ env.PACKAGE_NAME }}.zip
            ${{ env.PACKAGE_NAME }}.zip.sha256
            ${{ env.PACKAGE_NAME }}.7z
            ${{ env.PACKAGE_NAME }}.7z.sha256
          retention-days: 90

      - name: Upload PHP Build Artifacts (for extension building)
        uses: actions/upload-artifact@v4
        with:
          name: php-build-artifacts-${{ github.event.inputs.arch }}-${{ github.event.inputs.thread_safe }}
          path: artifacts/
          retention-days: 7

  # æž„å»ºæ‰©å±•ï¼ˆå¯é€‰ï¼‰
  build-extensions:
    if: github.event.inputs.build_extensions == 'true'
    needs: [prepare, build-php]
    runs-on: windows-2022
    strategy:
      fail-fast: false
      matrix:
        extension: ${{ fromJson(needs.prepare.outputs.extensions-json) }}
    steps:
      - name: Download PHP Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: php-build-artifacts-${{ github.event.inputs.arch }}-${{ github.event.inputs.thread_safe }}
          path: ${{ runner.temp }}/php-build-artifacts

      - name: Prepare PHP Build for Extension
        shell: powershell
        run: |
          Write-Host "==> Locating PHP build artifacts"

          $artifactPath = "${{ runner.temp }}\php-build-artifacts"

          # æŸ¥æ‰¾ä¸‹è½½çš„ PHP artifacts
          if (Test-Path $artifactPath) {
            Write-Host "PHP build artifacts directory found at: $artifactPath"
            Get-ChildItem -Path $artifactPath -Recurse | Select-Object Name, Length, FullName | ForEach-Object {
              Write-Host "  - $($_.Name) ($($_.Length) bytes)"
            }

            # ä¿å­˜è·¯å¾„ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
            echo "PHP_ARTIFACT_PATH=$artifactPath" >> $env:GITHUB_ENV
            Write-Host "PHP_ARTIFACT_PATH set to: $artifactPath"
          } else {
            Write-Host "Error: php-build-artifacts directory not found at: $artifactPath"
            exit 1
          }

      - name: Build Extension - ${{ matrix.extension.name }}
        uses: ServBay/php-windows-builder/extension@master
        with:
          extension-url: ${{ matrix.extension.url }}
          extension-ref: ${{ matrix.extension.ref }}
          php-version: ${{ needs.prepare.outputs.php-build-version }}
          arch: ${{ github.event.inputs.arch }}
          ts: ${{ github.event.inputs.thread_safe }}
          args: ${{ matrix.extension.args }}
          libs: ${{ matrix.extension.libs || '' }}
          php-build-path: ${{ env.PHP_ARTIFACT_PATH }}
          run-tests: ${{ github.event.inputs.version_type == 'stable' }}

      - name: Upload Extension Artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-${{ matrix.extension.name }}-${{ needs.prepare.outputs.php-version }}-${{ github.event.inputs.arch }}-${{ github.event.inputs.thread_safe }}
          path: artifacts/
          retention-days: 90

  # æ‰“åŒ…å®Œæ•´ PHPï¼ˆåŒ…å«æ‰€æœ‰æ‰©å±•ï¼‰
  package-php-complete:
    if: github.event.inputs.build_extensions == 'true'
    needs: [prepare, build-php, build-extensions]
    runs-on: windows-2022
    steps:
      - name: Download PHP Release Package
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.prepare.outputs.package-name }}
          path: php-package

      - name: Download Extension Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: extension-*
          path: extensions

      - name: Extract and Locate PHP
        shell: powershell
        run: |
          Write-Host "==> Extracting PHP package and locating PHP root"

          # æ˜¾ç¤ºå¹¶éªŒè¯å·¥ä½œç›®å½•
          $workDir = Get-Location
          Write-Host "Current working directory: $workDir"
          Write-Host "Workspace: $env:GITHUB_WORKSPACE"

          Write-Host "`nContents of current directory:"
          Get-ChildItem -Path . | ForEach-Object {
            $type = if ($_.PSIsContainer) { "DIR " } else { "FILE" }
            Write-Host "  [$type] $($_.Name)"
          }

          # æ˜¾ç¤º php-package çš„å®žé™…å†…å®¹
          Write-Host "`nContents of php-package:"
          if (Test-Path "php-package") {
            Get-ChildItem -Path "php-package" | ForEach-Object {
              $type = if ($_.PSIsContainer) { "DIR " } else { "FILE" }
              Write-Host "  [$type] $($_.Name)"
            }
          } else {
            Write-Host "ERROR: php-package directory not found in current directory"
            exit 1
          }

          # é€’å½’è§£åŽ‹å‡½æ•°
          function Expand-NestedZips {
            param(
              [string]$SourcePath,
              [string]$DestPath,
              [string]$Pattern = "*",
              [int]$Depth = 0
            )

            $indent = "  " * $Depth
            Write-Host "${indent}[Depth $Depth] Extracting from: $SourcePath"

            # æŸ¥æ‰¾ ZIP æ–‡ä»¶
            $zipFiles = Get-ChildItem -Path $SourcePath -Filter "*.zip" -File -ErrorAction SilentlyContinue

            if ($zipFiles.Count -eq 0) {
              Write-Host "${indent}No ZIP files found, extraction complete"
              return $SourcePath
            }

            # æ ¹æ® pattern ç­›é€‰ ZIPï¼ˆç”¨äºŽ PHP äºŒè¿›åˆ¶åŒ…é€‰æ‹©ï¼‰
            if ($Pattern -ne "*") {
              $filteredZips = $zipFiles | Where-Object {
                $_.Name -match $Pattern -and
                $_.Name -notmatch '(-debug-pack-|-devel-pack-|-test-pack-|-src\.zip)'
              }
              if ($filteredZips.Count -gt 0) {
                $zipFiles = $filteredZips
              }
            }

            Write-Host "${indent}Found $($zipFiles.Count) ZIP file(s)"

            # è§£åŽ‹ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ ZIP
            $zipFile = $zipFiles | Select-Object -First 1
            Write-Host "${indent}Extracting: $($zipFile.Name) ($([math]::Round($zipFile.Length / 1MB, 2)) MB)"

            if (-not (Test-Path $DestPath)) {
              New-Item -ItemType Directory -Path $DestPath | Out-Null
            }

            Add-Type -Assembly "System.IO.Compression.Filesystem"
            try {
              [System.IO.Compression.ZipFile]::ExtractToDirectory($zipFile.FullName, $DestPath)
            } catch {
              Write-Host "${indent}ERROR: Failed to extract: $_"
              throw
            }

            Write-Host "${indent}Extraction completed. Contents:"
            Get-ChildItem -Path $DestPath | Select-Object -First 10 | ForEach-Object {
              $type = if ($_.PSIsContainer) { "DIR " } else { "FILE" }
              Write-Host "${indent}  [$type] $($_.Name)"
            }

            # é€’å½’æ£€æŸ¥è§£åŽ‹åŽçš„å†…å®¹
            $innerZips = Get-ChildItem -Path $DestPath -Filter "*.zip" -File -ErrorAction SilentlyContinue
            if ($innerZips.Count -gt 0) {
              Write-Host "${indent}Nested ZIP detected, continuing recursion..."
              $newDest = "$DestPath-level$($Depth + 1)"
              return Expand-NestedZips -SourcePath $DestPath -DestPath $newDest -Pattern $Pattern -Depth ($Depth + 1)
            } else {
              Write-Host "${indent}No more nested ZIPs, recursion complete"
              return $DestPath
            }
          }

          # æŸ¥æ‰¾ PHP ZIP
          $phpZip = Get-ChildItem -Path "php-package" -Filter "*.zip" -File | Select-Object -First 1
          $searchRoot = $null

          if ($null -ne $phpZip) {
            Write-Host "`n==> Starting recursive extraction"
            $searchRoot = Expand-NestedZips -SourcePath "php-package" -DestPath "php-extract" -Pattern 'php-.*-(nts|ts)-Win.*\.zip$' -Depth 0
            Write-Host "`nFinal search root: $searchRoot"
          } else {
            Write-Host "`n==> No ZIP file, using directory directly"
            $searchRoot = "php-package"
          }

          # é€’å½’æŸ¥æ‰¾ php.exe ç¡®å®šçœŸæ­£çš„ PHP æ ¹ç›®å½•
          Write-Host "`nLocating php.exe in: $searchRoot"

          $phpExe = Get-ChildItem -Path $searchRoot -Filter "php.exe" -Recurse -File -ErrorAction SilentlyContinue | Select-Object -First 1

          if ($null -eq $phpExe) {
            Write-Host "ERROR: php.exe not found in $searchRoot"

            Write-Host "`nAttempting to list all directories in search root:"
            $allDirs = Get-ChildItem -Path $searchRoot -Recurse -Directory -ErrorAction SilentlyContinue | Select-Object -First 20
            if ($null -ne $allDirs -and $allDirs.Count -gt 0) {
              Write-Host "Found $($allDirs.Count) directories:"
              $allDirs | ForEach-Object {
                Write-Host "  - $($_.FullName)"
              }
            } else {
              Write-Host "No directories found in $searchRoot"
            }

            Write-Host "`nAttempting to list all .exe files in search root:"
            $allExes = Get-ChildItem -Path $searchRoot -Filter "*.exe" -Recurse -File -ErrorAction SilentlyContinue
            if ($null -ne $allExes -and $allExes.Count -gt 0) {
              Write-Host "Found $($allExes.Count) .exe files:"
              $allExes | ForEach-Object {
                Write-Host "  - $($_.FullName)"
              }
            } else {
              Write-Host "No .exe files found in $searchRoot"
            }

            exit 1
          }

          $phpRootPath = $phpExe.Directory.FullName
          Write-Host "[OK] Found PHP root: $phpRootPath"

          # ç§»åŠ¨åˆ°æ ‡å‡†ä½ç½®
          $phpRoot = "php"
          if (Test-Path $phpRoot) {
            Remove-Item $phpRoot -Recurse -Force
          }

          Write-Host "Moving PHP to standard location: $phpRoot"
          Move-Item $phpRootPath $phpRoot

          # æ¸…ç†æ‰€æœ‰ä¸´æ—¶ç›®å½•ï¼ˆåŒ…æ‹¬é€’å½’è§£åŽ‹äº§ç”Ÿçš„å¤šå±‚ç›®å½•ï¼‰
          Write-Host "`nCleaning up temporary directories..."

          # æ¸…ç† PHP è§£åŽ‹äº§ç”Ÿçš„æ‰€æœ‰ä¸´æ—¶ç›®å½•
          Get-ChildItem -Path . -Directory -Filter "php-extract*" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Removing: $($_.Name)"
            Remove-Item $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
          }

          # æ¸…ç†æ‰©å±•è§£åŽ‹äº§ç”Ÿçš„æ‰€æœ‰ä¸´æ—¶ç›®å½•
          Get-ChildItem -Path . -Directory -Filter "ext-*-extract*" -ErrorAction SilentlyContinue | ForEach-Object {
            Write-Host "  Removing: $($_.Name)"
            Remove-Item $_.FullName -Recurse -Force -ErrorAction SilentlyContinue
          }

          Write-Host "Cleanup completed"

          # éªŒè¯ PHP ç›®å½•ç»“æž„
          Write-Host "`nVerifying PHP structure:"
          $phpExePath = Join-Path $phpRoot "php.exe"
          $extDirPath = Join-Path $phpRoot "ext"

          if (-not (Test-Path $phpExePath)) {
            Write-Host "ERROR: php.exe not found at $phpExePath"
            exit 1
          }

          if (-not (Test-Path $extDirPath)) {
            Write-Host "Creating ext directory"
            New-Item -ItemType Directory -Path $extDirPath | Out-Null
          }

          Write-Host "[OK] PHP root verified: $phpRoot"

      - name: Integrate Extensions
        shell: powershell
        run: |
          # é€’å½’è§£åŽ‹å‡½æ•°ï¼ˆä¸Ž Extract and Locate PHP æ­¥éª¤ä¸­ç›¸åŒï¼‰
          function Expand-NestedZips {
            param(
              [string]$SourcePath,
              [string]$DestPath,
              [string]$Pattern = "*",
              [int]$Depth = 0
            )

            $indent = "  " * $Depth
            Write-Host "${indent}[Depth $Depth] Extracting from: $SourcePath"

            # æŸ¥æ‰¾ ZIP æ–‡ä»¶
            $zipFiles = Get-ChildItem -Path $SourcePath -Filter "*.zip" -File -ErrorAction SilentlyContinue

            if ($zipFiles.Count -eq 0) {
              Write-Host "${indent}No ZIP files found, extraction complete"
              return $SourcePath
            }

            # æ ¹æ® pattern ç­›é€‰ ZIPï¼ˆç”¨äºŽ PHP äºŒè¿›åˆ¶åŒ…é€‰æ‹©ï¼‰
            if ($Pattern -ne "*") {
              $filteredZips = $zipFiles | Where-Object {
                $_.Name -match $Pattern -and
                $_.Name -notmatch '(-debug-pack-|-devel-pack-|-test-pack-|-src\.zip)'
              }
              if ($filteredZips.Count -gt 0) {
                $zipFiles = $filteredZips
              }
            }

            Write-Host "${indent}Found $($zipFiles.Count) ZIP file(s)"

            # è§£åŽ‹ç¬¬ä¸€ä¸ªç¬¦åˆæ¡ä»¶çš„ ZIP
            $zipFile = $zipFiles | Select-Object -First 1
            Write-Host "${indent}Extracting: $($zipFile.Name) ($([math]::Round($zipFile.Length / 1MB, 2)) MB)"

            if (-not (Test-Path $DestPath)) {
              New-Item -ItemType Directory -Path $DestPath | Out-Null
            }

            Add-Type -Assembly "System.IO.Compression.Filesystem"
            try {
              [System.IO.Compression.ZipFile]::ExtractToDirectory($zipFile.FullName, $DestPath)
            } catch {
              Write-Host "${indent}ERROR: Failed to extract: $_"
              throw
            }

            Write-Host "${indent}Extraction completed. Contents:"
            Get-ChildItem -Path $DestPath | Select-Object -First 10 | ForEach-Object {
              $type = if ($_.PSIsContainer) { "DIR " } else { "FILE" }
              Write-Host "${indent}  [$type] $($_.Name)"
            }

            # é€’å½’æ£€æŸ¥è§£åŽ‹åŽçš„å†…å®¹
            $innerZips = Get-ChildItem -Path $DestPath -Filter "*.zip" -File -ErrorAction SilentlyContinue
            if ($innerZips.Count -gt 0) {
              Write-Host "${indent}Nested ZIP detected, continuing recursion..."
              $newDest = "$DestPath-level$($Depth + 1)"
              return Expand-NestedZips -SourcePath $DestPath -DestPath $newDest -Pattern $Pattern -Depth ($Depth + 1)
            } else {
              Write-Host "${indent}No more nested ZIPs, recursion complete"
              return $DestPath
            }
          }

          Write-Host "==> Integrating extensions into PHP"

          # æ˜¾ç¤ºå¹¶éªŒè¯å·¥ä½œç›®å½•
          $workDir = Get-Location
          Write-Host "Current working directory: $workDir"

          Write-Host "`nContents of current directory:"
          Get-ChildItem -Path . | ForEach-Object {
            $type = if ($_.PSIsContainer) { "DIR " } else { "FILE" }
            Write-Host "  [$type] $($_.Name)"
          }

          $phpRoot = "php"
          $extDir = Join-Path $phpRoot "ext"

          # éªŒè¯ PHP ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path $phpRoot)) {
            Write-Host "ERROR: PHP directory '$phpRoot' not found in current directory"
            Write-Host "This step depends on the previous 'Extract and Locate PHP' step"
            exit 1
          }

          Write-Host "`nPHP directory found: $((Get-Item $phpRoot).FullName)"

          # ç»Ÿè®¡å˜é‡
          $totalExtensions = 0
          $totalDlls = 0
          $totalInis = 0
          $totalConfigs = 0

          # æ£€æŸ¥ extensions ç›®å½•æ˜¯å¦å­˜åœ¨
          if (-not (Test-Path "extensions")) {
            Write-Host "WARNING: extensions directory not found, skipping extension integration"
            exit 0
          }

          Write-Host "`nAnalyzing downloaded extension artifacts..."
          Write-Host "Contents of extensions:"
          Get-ChildItem -Path "extensions" -Directory | ForEach-Object {
            Write-Host "  [DIR] $($_.Name)"
          }

          # èŽ·å–æ‰€æœ‰æ‰©å±•ç›®å½•
          $extensionDirs = Get-ChildItem -Path "extensions" -Directory -ErrorAction SilentlyContinue

          if ($null -eq $extensionDirs -or $extensionDirs.Count -eq 0) {
            Write-Host "WARNING: No extension directories found in extensions/"
            exit 0
          }

          Write-Host "`nFound $($extensionDirs.Count) extension(s) to process"

          foreach ($extDir_Item in $extensionDirs) {
            $extName = $extDir_Item.Name -replace '^extension-([^-]+).*', '$1'
            Write-Host "`n========================================`n==> Processing extension: $extName`n========================================"
            $totalExtensions++

            # æ˜¾ç¤ºæ‰©å±• artifact å†…å®¹
            Write-Host "Artifact contents:"
            Get-ChildItem -Path $extDir_Item.FullName | Select-Object -First 10 | ForEach-Object {
              $type = if ($_.PSIsContainer) { "DIR " } else { "FILE" }
              Write-Host "  [$type] $($_.Name)"
            }

            # æ£€æµ‹æ˜¯å¦æœ‰ zip æ–‡ä»¶éœ€è¦é€’å½’è§£åŽ‹
            $extZipFiles = Get-ChildItem -Path $extDir_Item.FullName -Filter "*.zip" -File -ErrorAction SilentlyContinue
            $extSearchRoot = $null

            if ($null -ne $extZipFiles -and $extZipFiles.Count -gt 0) {
              Write-Host "`n[ZIP Mode] Found $($extZipFiles.Count) ZIP file(s), starting recursive extraction..."

              # ä½¿ç”¨é€’å½’è§£åŽ‹å‡½æ•°å¤„ç†å¯èƒ½çš„åµŒå¥— ZIP
              $extExtractBase = "ext-$extName-extract"
              $extSearchRoot = Expand-NestedZips -SourcePath $extDir_Item.FullName -DestPath $extExtractBase -Pattern "*" -Depth 0

              Write-Host "`nFinal search root for $extName : $extSearchRoot"
            } else {
              Write-Host "`n[Directory Mode] No ZIP files, using directory directly"
              $extSearchRoot = $extDir_Item.FullName
            }

            # æ˜¾ç¤ºå®žé™…æœç´¢æ ¹ç›®å½•çš„ç»“æž„
            Write-Host "`nSearching in: $extSearchRoot"
            Write-Host "Directory structure (top 2 levels, first 15 items):"
            $extSearchRootFullPath = (Get-Item $extSearchRoot).FullName
            Get-ChildItem -Path $extSearchRoot -Recurse -Depth 2 -ErrorAction SilentlyContinue | Select-Object -First 15 | ForEach-Object {
              try {
                $relativePath = $_.FullName.Substring($extSearchRootFullPath.Length)
                $type = if ($_.PSIsContainer) { "DIR " } else { "FILE" }
                Write-Host "  [$type] $relativePath"
              } catch {
                # å¿½ç•¥è·¯å¾„å¤„ç†é”™è¯¯
              }
            }

            # é€’å½’æŸ¥æ‰¾æ‰©å±•ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶
            $allFiles = Get-ChildItem -Path $extSearchRoot -Recurse -File -ErrorAction SilentlyContinue

            if ($null -eq $allFiles -or $allFiles.Count -eq 0) {
              Write-Host "WARNING: No files found in $extSearchRoot, skipping"
              if ($null -ne $extTempDir -and (Test-Path $extTempDir)) {
                Remove-Item $extTempDir -Recurse -Force -ErrorAction SilentlyContinue
              }
              continue
            }

            Write-Host "`nFound $($allFiles.Count) files in extension package"

            # ç»Ÿè®¡æ–‡ä»¶ç±»åž‹
            $extDllCount = 0
            $depDllCount = 0
            $iniCount = 0
            $configDirCount = 0

            # å¤„ç† DLL æ–‡ä»¶
            $dllFiles = $allFiles | Where-Object { $_.Extension -eq ".dll" }
            Write-Host "`nProcessing $($dllFiles.Count) DLL files:"

            foreach ($dll in $dllFiles) {
              if ($dll.Name -match '^php_([^-]+).*\.dll$') {
                # PHP æ‰©å±• DLL: php_*.dll
                $extBaseName = $matches[1]
                $targetName = "php_$extBaseName.dll"
                $targetPath = Join-Path $extDir $targetName
                Write-Host "  [EXT] $($dll.Name) -> ext\$targetName"
                Copy-Item $dll.FullName -Destination $targetPath -Force
                $extDllCount++
                $totalDlls++
              } else {
                # ä¾èµ–åº“ DLL: å¤åˆ¶åˆ° PHP æ ¹ç›®å½•
                $targetPath = Join-Path $phpRoot $dll.Name
                Write-Host "  [DEP] $($dll.Name) -> root\"
                Copy-Item $dll.FullName -Destination $targetPath -Force
                $depDllCount++
                $totalDlls++
              }
            }

            # å¤„ç† INI æ–‡ä»¶
            $iniFiles = $allFiles | Where-Object { $_.Extension -eq ".ini" }
            if ($iniFiles.Count -gt 0) {
              Write-Host "`nProcessing $($iniFiles.Count) INI files:"
              foreach ($ini in $iniFiles) {
                $targetPath = Join-Path $phpRoot $ini.Name
                Write-Host "  [INI] $($ini.Name) -> root\"
                Copy-Item $ini.FullName -Destination $targetPath -Force
                $iniCount++
                $totalInis++
              }
            }

            # å¤„ç† config ç›®å½•ï¼ˆé€’å½’å¤åˆ¶æ•´ä¸ªç›®å½•ç»“æž„ï¼‰
            $configDirs = Get-ChildItem -Path $extSearchRoot -Directory -Recurse -ErrorAction SilentlyContinue | Where-Object { $_.Name -eq "config" }
            if ($configDirs) {
              Write-Host "`nProcessing config directories:"
              foreach ($configDir in $configDirs) {
                $targetConfigDir = Join-Path $phpRoot "config"
                Write-Host "  [CFG] $($configDir.FullName) -> root\config\"
                if (-not (Test-Path $targetConfigDir)) {
                  New-Item -ItemType Directory -Path $targetConfigDir | Out-Null
                }
                Copy-Item $configDir.FullName -Destination $phpRoot -Recurse -Force
                $configDirCount++
                $totalConfigs++
              }
            }

            # å¤„ç†å…¶ä»–é…ç½®æ–‡ä»¶ (xml, conf, txt)
            $otherConfigs = $allFiles | Where-Object { $_.Extension -in ".xml", ".conf", ".txt" }
            if ($otherConfigs.Count -gt 0) {
              Write-Host "`nProcessing $($otherConfigs.Count) config files:"
              foreach ($config in $otherConfigs) {
                # ä¿æŒç›¸å¯¹è·¯å¾„ç»“æž„ï¼ˆä½¿ç”¨å®žé™…çš„æœç´¢æ ¹ç›®å½•ï¼‰
                $relativePath = $config.FullName.Substring($extSearchRootFullPath.Length + 1)
                $targetPath = Join-Path $phpRoot $relativePath
                $targetDir = Split-Path $targetPath -Parent

                if (-not (Test-Path $targetDir)) {
                  New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
                }

                Write-Host "  [CFG] $relativePath -> root\$relativePath"
                Copy-Item $config.FullName -Destination $targetPath -Force
              }
            }

            # éªŒè¯å…³é”®æ–‡ä»¶
            Write-Host "`n--- Extension Summary ---"
            Write-Host "  Extension DLLs: $extDllCount"
            Write-Host "  Dependency DLLs: $depDllCount"
            Write-Host "  INI files: $iniCount"
            Write-Host "  Config dirs: $configDirCount"

            if ($extDllCount -eq 0) {
              Write-Host "  WARNING: No extension DLL found for $extName"
            }

            # é’ˆå¯¹ç‰¹å®šæ‰©å±•çš„éªŒè¯
            if ($extName -eq "imagick") {
              $coreDlls = $dllFiles | Where-Object { $_.Name -match "^CORE_RL_" }
              if ($coreDlls.Count -eq 0) {
                Write-Host "  WARNING: No CORE_RL_*.dll found for imagick"
              } else {
                Write-Host "  [OK] Found $($coreDlls.Count) CORE_RL_*.dll files"
              }
            }

            Write-Host "[OK] $extName integration complete"

            # æ¸…ç†ä¸´æ—¶ç›®å½•ï¼ˆå¦‚æžœæ˜¯ ZIP æ¨¡å¼ï¼‰
            if ($null -ne $extTempDir -and (Test-Path $extTempDir)) {
              Write-Host "Cleaning up temporary directory..."
              Remove-Item $extTempDir -Recurse -Force -ErrorAction SilentlyContinue
            }
          }

          # æ€»ä½“æ‘˜è¦
          Write-Host "`n========================================"
          Write-Host "==> Integration Complete"
          Write-Host "========================================"
          Write-Host "Total extensions processed: $totalExtensions"
          Write-Host "Total DLLs copied: $totalDlls"
          Write-Host "Total INI files: $totalInis"
          Write-Host "Total config directories: $totalConfigs"

          # åˆ—å‡ºæœ€ç»ˆçš„ ext ç›®å½•
          Write-Host "`nFinal ext\ directory:"
          Get-ChildItem -Path $extDir -Filter "php_*.dll" | ForEach-Object {
            Write-Host "  - $($_.Name)"
          }

      - name: Create Complete PHP Package
        shell: powershell
        run: |
          Write-Host "==> Creating complete PHP package with extensions"

          # æ˜¾ç¤ºå¹¶éªŒè¯å·¥ä½œç›®å½•
          $workDir = Get-Location
          Write-Host "Current working directory: $workDir"

          Write-Host "`nContents of current directory:"
          Get-ChildItem -Path . | ForEach-Object {
            $type = if ($_.PSIsContainer) { "DIR " } else { "FILE" }
            Write-Host "  [$type] $($_.Name)"
          }

          # æž„é€ å®Œæ•´åŒ…åï¼ˆå®Œæ•´åŒ…ï¼šphp-{version}-windows-{arch}ï¼‰
          $PHP_VERSION = "${{ needs.prepare.outputs.php-version }}"
          $ARCH = "${{ github.event.inputs.arch }}"
          $packageName = "php-$PHP_VERSION-windows-$ARCH"
          $phpRoot = "php"

          # éªŒè¯ PHP ç›®å½•
          if (-not (Test-Path $phpRoot)) {
            Write-Host "ERROR: PHP directory not found: $phpRoot"
            Write-Host "This step depends on previous steps completing successfully"
            exit 1
          }

          Write-Host "`nPHP directory found: $((Get-Item $phpRoot).FullName)"

          $phpExe = Join-Path $phpRoot "php.exe"
          if (-not (Test-Path $phpExe)) {
            Write-Host "ERROR: php.exe not found"
            exit 1
          }

          # ç»Ÿè®¡åŒ…å†…å®¹
          Write-Host "`nPackage contents:"
          $extDlls = Get-ChildItem -Path (Join-Path $phpRoot "ext") -Filter "php_*.dll" -ErrorAction SilentlyContinue
          Write-Host "  Extensions: $($extDlls.Count) DLLs"

          $rootDlls = Get-ChildItem -Path $phpRoot -Filter "*.dll" -File -ErrorAction SilentlyContinue
          Write-Host "  Root DLLs: $($rootDlls.Count)"

          $iniFiles = Get-ChildItem -Path $phpRoot -Filter "*.ini" -File -ErrorAction SilentlyContinue
          Write-Host "  INI files: $($iniFiles.Count)"

          $configDir = Join-Path $phpRoot "config"
          if (Test-Path $configDir) {
            $configFiles = Get-ChildItem -Path $configDir -Recurse -File
            Write-Host "  Config files: $($configFiles.Count)"
          }

          # ä½¿ç”¨ 7-Zip ç”Ÿæˆ ZIP æ ¼å¼ï¼ˆç¡®ä¿è·¯å¾„ä½¿ç”¨æ­£æ–œæ ï¼‰
          Write-Host "`nCreating ZIP package..."
          & "C:\Program Files\7-Zip\7z.exe" a -tzip "$packageName.zip" ".\$phpRoot\*"
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Failed to create ZIP package"
            exit 1
          }

          $zipSizeInMB = [math]::Round((Get-Item "$packageName.zip").Length / 1MB, 2)
          Write-Host "[OK] ZIP package created: $packageName.zip"
          Write-Host "  Size: $zipSizeInMB MB"

          # ç”Ÿæˆ ZIP çš„ SHA256
          $zipHash = (Get-FileHash -Path "$packageName.zip" -Algorithm SHA256).Hash
          "$zipHash  $packageName.zip" | Out-File -FilePath "$packageName.zip.sha256" -Encoding ASCII
          Write-Host "  SHA256: $zipHash"

          # ä½¿ç”¨ 7-Zip ç”Ÿæˆ 7Z æ ¼å¼ï¼ˆæ›´é«˜åŽ‹ç¼©çŽ‡ï¼‰
          Write-Host "`nCreating 7Z package..."
          & "C:\Program Files\7-Zip\7z.exe" a -t7z -m0=lzma2 -mx=9 -mmt=on "$packageName.7z" ".\$phpRoot\*"
          if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Failed to create 7Z package"
            exit 1
          }

          $7zSizeInMB = [math]::Round((Get-Item "$packageName.7z").Length / 1MB, 2)
          Write-Host "[OK] 7Z package created: $packageName.7z"
          Write-Host "  Size: $7zSizeInMB MB"

          # ç”Ÿæˆ 7Z çš„ SHA256
          $7zHash = (Get-FileHash -Path "$packageName.7z" -Algorithm SHA256).Hash
          "$7zHash  $packageName.7z" | Out-File -FilePath "$packageName.7z.sha256" -Encoding ASCII
          Write-Host "  SHA256: $7zHash"

      - name: Upload Complete PHP Package
        uses: actions/upload-artifact@v4
        with:
          name: php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}
          path: |
            php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}.zip
            php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}.zip.sha256
            php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}.7z
            php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}.7z.sha256
          retention-days: 90

  # åˆ›å»º Release
  create-release:
    if: |
      github.event.inputs.create_release == 'true' &&
      always() &&
      !cancelled() &&
      needs.build-php.result == 'success'
    needs: [prepare, build-php, build-extensions, package-php-complete]
    runs-on: ubuntu-latest
    steps:
      - name: Download Complete PHP Package
        uses: actions/download-artifact@v4
        with:
          name: php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}
          path: release-assets

      - name: Debug - List Downloaded Files
        run: |
          echo "==> Contents of release-assets directory:"
          ls -lah release-assets/
          echo ""
          echo "==> Finding all files:"
          find release-assets -type f
          echo ""
          echo "==> Current directory:"
          pwd
          ls -lah

      - name: Create BUILD_INFO.md
        run: |
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          cat > BUILD_INFO.md << EOF
          # PHP for Windows - æž„å»ºä¿¡æ¯

          ## ç‰ˆæœ¬ä¿¡æ¯

          - **PHP ç‰ˆæœ¬**: ${{ needs.prepare.outputs.php-version }}
          - **ç‰ˆæœ¬ç±»åž‹**: ${{ needs.prepare.outputs.version-type }}
          - **æž¶æž„**: ${{ github.event.inputs.arch }}
          - **çº¿ç¨‹å®‰å…¨**: ${{ github.event.inputs.thread_safe }}
          - **æž„å»ºæ—¶é—´**: ${BUILD_TIME}
          - **æž„å»ºç¼–å·**: ${{ github.run_number }}

          ## æž„å»ºæ¥æº

          - **æºç æ¥æº**: ${{ needs.prepare.outputs.php-source }}
          - **æž„å»ºå·¥å…·**: php-windows-builder (å®˜æ–¹)
          - **GitHub Actions**: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## å®‰è£…è¯´æ˜Ž

          1. ä¸‹è½½å¯¹åº”çš„ ZIP åŒ…
          2. éªŒè¯ SHA256 æ ¡éªŒå’Œ
          3. è§£åŽ‹åˆ°ç›®æ ‡ç›®å½•
          4. é…ç½® php.ini
          5. æ·»åŠ åˆ°ç³»ç»Ÿ PATH

          ## SHA256 æ ¡éªŒ

          è¯·ä½¿ç”¨æä¾›çš„ .sha256 æ–‡ä»¶éªŒè¯ä¸‹è½½å®Œæ•´æ€§ï¼š

          ```powershell
          # Windows PowerShell
          $hash = (Get-FileHash -Path "php-*.zip" -Algorithm SHA256).Hash
          $expected = (Get-Content "php-*.sha256").Split()[0]
          if ($hash -eq $expected) { Write-Host "[OK] éªŒè¯é€šè¿‡" } else { Write-Host "[ERROR] éªŒè¯å¤±è´¥" }
          ```

          ```bash
          # Linux/macOS
          sha256sum -c php-*.sha256
          ```

          ## æ”¯æŒä¸Žåé¦ˆ

          - é—®é¢˜åé¦ˆ: https://github.com/${{ github.repository }}/issues
          - é¡¹ç›®ä¸»é¡µ: https://github.com/${{ github.repository }}

          ---

          ðŸ¤– ç”± [PHP Windows Builder](https://github.com/php/php-windows-builder) æž„å»º
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: php-${{ needs.prepare.outputs.php-version }}-${{ github.event.inputs.arch }}-${{ github.event.inputs.thread_safe }}
          name: PHP ${{ needs.prepare.outputs.php-version }} for Windows (${{ github.event.inputs.arch }}/${{ github.event.inputs.thread_safe }})
          body_path: BUILD_INFO.md
          files: |
            release-assets/php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}.zip
            release-assets/php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}.zip.sha256
            release-assets/php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}.7z
            release-assets/php-${{ needs.prepare.outputs.php-version }}-windows-${{ github.event.inputs.arch }}.7z.sha256
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
